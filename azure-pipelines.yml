trigger:
- main  # Trigger the pipeline for changes in the 'main' branch

pool:
  vmImage: 'windows-latest'  # Use a Windows-based build agent

variables:
  BOOST_ROOT: '$(System.DefaultWorkingDirectory)/boost'
  BUILD_DIR: '$(Build.BinariesDirectory)'

steps:
# Step 1: Checkout the repository
- checkout: self
  clean: true  # Ensures a clean workspace before checkout
  fetchDepth: 1  # Shallow clone to improve performance
  displayName: 'Checkout Source Code'

# Step 2: Download and extract Boost source code
- script: |
    curl -L https://boostorg.jfrog.io/artifactory/main/release/1.83.0/source/boost_1_83_0.zip -o boost.zip
    tar -xf boost.zip -C $(System.DefaultWorkingDirectory)
    rename boost_1_83_0 boost
  displayName: 'Download Boost Source Code'

# Step 3: Build Boost.JSON
- script: |
    cd $(BOOST_ROOT)
    bootstrap.bat
    b2 --with-json address-model=32 variant=release link=static runtime-link=shared
  displayName: 'Build Boost Libraries'

# Step 4: Configure the build with CMake
- script: |
    mkdir $(BUILD_DIR)
    cd $(BUILD_DIR)
    cmake -G "Visual Studio 17 2022" -A Win32 -DBOOST_ROOT=$(BOOST_ROOT) ..
  displayName: 'Configure Build with CMake'

# Step 5: Build the application
- script: |
    cd $(BUILD_DIR)
    cmake --build . --config Release
  displayName: 'Build the Application'

# Step 6: Publish build artifacts (optional)
- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(BUILD_DIR)'
    artifactName: 'drop'
    publishLocation: 'Container'
  displayName: 'Publish Build Artifacts'
